BeforeAll -Scriptblock {
    $csr = [System.IO.Path]::GetTempFileName()
    $attestationcert = [System.IO.Path]::GetTempFileName()
    $intermediatecert = [System.IO.Path]::GetTempFileName()
}

Describe "Confirm-YubikeyAttestion requestWithBuiltinAttestion" {
    BeforeEach -Scriptblock {
        #Get-Variable pest*|Remove-Variable
    }

    It -Name "Verify 'Confirm-YubikeyAttestion -CertificateRequest _file_' works" -Test {
        Set-Content -Path $csr -Value @'
-----BEGIN CERTIFICATE REQUEST-----
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
-----END CERTIFICATE REQUEST-----
'@
        $pest_return = Confirm-YubikeyAttestion -CertificateRequest $csr
        $pest_return | Should -BeOfType VirotYubikey.Attestion
        $pest_return.Slot | Should -Be 0x9a
        $pest_return.AttestionValidated | Should -Be $True
        $pest_return.AttestionMatchesCSR | Should -Be $True
    }
    It -Name "Verify 'Confirm-YubikeyAttestion -CertificateRequest _PEM_' works" -Test {
        $pest_csr = @'
-----BEGIN CERTIFICATE REQUEST-----
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
-----END CERTIFICATE REQUEST-----
'@
        $pest_return = Confirm-YubikeyAttestion -CertificateRequest $pest_csr
        $pest_return | Should -BeOfType VirotYubikey.Attestion
        $pest_return.Slot | Should -Be 0x9a
        $pest_return.AttestionValidated | Should -Be $True
        $pest_return.AttestionMatchesCSR | Should -Be $True
    }
    It -Name "Verify 'Confirm-YubikeyAttestion -CertificateRequest _CertificateRequest_' works" -Test {
        $pest_input = [byte[]](0x30, 0x82, 0x6, 0xEC, 0x30, 0x82, 0x6, 0x72, 0x2, 0x1, 0x0, 0x30, 0x3E, 0x31, 0xD, 0x30, 0xB, 0x6, 0x3, 0x55, 0x4, 0xA, 0x13, 0x4, 0x46, 0x61, 0x6B, 0x65, 0x31, 0x2D, 0x30, 0x2B, 0x6, 0x3, 0x55, 0x4, 0x3, 0x13, 0x24, 0x53, 0x75, 0x62, 0x6A, 0x65, 0x63, 0x74, 0x4E, 0x61, 0x6D, 0x65, 0x20, 0x74, 0x6F, 0x20, 0x62, 0x65, 0x20, 0x73, 0x75, 0x70, 0x70, 0x6C, 0x69, 0x65, 0x64, 0x20, 0x62, 0x79, 0x20, 0x53, 0x65, 0x72, 0x76, 0x65, 0x72, 0x30, 0x76, 0x30, 0x10, 0x6, 0x7, 0x2A, 0x86, 0x48, 0xCE, 0x3D, 0x2, 0x1, 0x6, 0x5, 0x2B, 0x81, 0x4, 0x0, 0x22, 0x3, 0x62, 0x0, 0x4, 0x18, 0x49, 0xC5, 0x3, 0xBD, 0x4B, 0x4D, 0x42, 0x88, 0x2, 0xC5, 0x5F, 0xFB, 0x6C, 0xD4, 0x6A, 0x82, 0x8, 0xAE, 0xDE, 0xB7, 0x3E, 0x4E, 0xF3, 0x3D, 0x3, 0x1D, 0x1C, 0xE6, 0x3E, 0x39, 0x41, 0x42, 0x97, 0x4E, 0x67, 0x4A, 0x3C, 0x1F, 0x27, 0x0, 0x7D, 0xBA, 0x48, 0x58, 0x67, 0x40, 0x4A, 0xA7, 0x93, 0x3C, 0xB4, 0x2E, 0x2E, 0xE0, 0x4, 0xD1, 0xF5, 0x77, 0xCB, 0x3E, 0xD3, 0x6A, 0xC, 0x1C, 0xCD, 0x58, 0x8B, 0xD7, 0xA5, 0xBE, 0x70, 0x53, 0xBF, 0xA0, 0xB5, 0x4F, 0xD9, 0xCE, 0x2E, 0xF8, 0xAC, 0x11, 0xB9, 0x9C, 0x25, 0x33, 0x17, 0xB, 0x4E, 0x8A, 0x82, 0x1C, 0xCF, 0x1F, 0x52, 0xA0, 0x82, 0x5, 0xB3, 0x30, 0x82, 0x5, 0xAF, 0x6, 0x9, 0x2A, 0x86, 0x48, 0x86, 0xF7, 0xD, 0x1, 0x9, 0xE, 0x31, 0x82, 0x5, 0xA0, 0x30, 0x82, 0x5, 0x9C, 0x30, 0x82, 0x2, 0x86, 0x6, 0xA, 0x2B, 0x6, 0x1, 0x4, 0x1, 0x82, 0xC4, 0xA, 0x3, 0xB, 0x4, 0x82, 0x2, 0x76, 0x30, 0x82, 0x2, 0x72, 0x30, 0x82, 0x1, 0x5A, 0xA0, 0x3, 0x2, 0x1, 0x2, 0x2, 0x10, 0x1, 0x59, 0xCA, 0xD1, 0x15, 0x62, 0xB6, 0x6D, 0xBB, 0x89, 0xFE, 0x58, 0x2E, 0x77, 0x3D, 0xBC, 0x30, 0xD, 0x6, 0x9, 0x2A, 0x86, 0x48, 0x86, 0xF7, 0xD, 0x1, 0x1, 0xB, 0x5, 0x0, 0x30, 0x21, 0x31, 0x1F, 0x30, 0x1D, 0x6, 0x3, 0x55, 0x4, 0x3, 0xC, 0x16, 0x59, 0x75, 0x62, 0x69, 0x63, 0x6F, 0x20, 0x50, 0x49, 0x56, 0x20, 0x41, 0x74, 0x74, 0x65, 0x73, 0x74, 0x61, 0x74, 0x69, 0x6F, 0x6E, 0x30, 0x20, 0x17, 0xD, 0x31, 0x36, 0x30, 0x33, 0x31, 0x34, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x5A, 0x18, 0xF, 0x32, 0x30, 0x35, 0x32, 0x30, 0x34, 0x31, 0x37, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x5A, 0x30, 0x25, 0x31, 0x23, 0x30, 0x21, 0x6, 0x3, 0x55, 0x4, 0x3, 0xC, 0x1A, 0x59, 0x75, 0x62, 0x69, 0x4B, 0x65, 0x79, 0x20, 0x50, 0x49, 0x56, 0x20, 0x41, 0x74, 0x74, 0x65, 0x73, 0x74, 0x61, 0x74, 0x69, 0x6F, 0x6E, 0x20, 0x39, 0x61, 0x30, 0x76, 0x30, 0x10, 0x6, 0x7, 0x2A, 0x86, 0x48, 0xCE, 0x3D, 0x2, 0x1, 0x6, 0x5, 0x2B, 0x81, 0x4, 0x0, 0x22, 0x3, 0x62, 0x0, 0x4, 0x18, 0x49, 0xC5, 0x3, 0xBD, 0x4B, 0x4D, 0x42, 0x88, 0x2, 0xC5, 0x5F, 0xFB, 0x6C, 0xD4, 0x6A, 0x82, 0x8, 0xAE, 0xDE, 0xB7, 0x3E, 0x4E, 0xF3, 0x3D, 0x3, 0x1D, 0x1C, 0xE6, 0x3E, 0x39, 0x41, 0x42, 0x97, 0x4E, 0x67, 0x4A, 0x3C, 0x1F, 0x27, 0x0, 0x7D, 0xBA, 0x48, 0x58, 0x67, 0x40, 0x4A, 0xA7, 0x93, 0x3C, 0xB4, 0x2E, 0x2E, 0xE0, 0x4, 0xD1, 0xF5, 0x77, 0xCB, 0x3E, 0xD3, 0x6A, 0xC, 0x1C, 0xCD, 0x58, 0x8B, 0xD7, 0xA5, 0xBE, 0x70, 0x53, 0xBF, 0xA0, 0xB5, 0x4F, 0xD9, 0xCE, 0x2E, 0xF8, 0xAC, 0x11, 0xB9, 0x9C, 0x25, 0x33, 0x17, 0xB, 0x4E, 0x8A, 0x82, 0x1C, 0xCF, 0x1F, 0x52, 0xA3, 0x4E, 0x30, 0x4C, 0x30, 0x11, 0x6, 0xA, 0x2B, 0x6, 0x1, 0x4, 0x1, 0x82, 0xC4, 0xA, 0x3, 0x3, 0x4, 0x3, 0x5, 0x4, 0x3, 0x30, 0x14, 0x6, 0xA, 0x2B, 0x6, 0x1, 0x4, 0x1, 0x82, 0xC4, 0xA, 0x3, 0x7, 0x4, 0x6, 0x2, 0x4, 0x1, 0x2C, 0x3, 0x77, 0x30, 0x10, 0x6, 0xA, 0x2B, 0x6, 0x1, 0x4, 0x1, 0x82, 0xC4, 0xA, 0x3, 0x8, 0x4, 0x2, 0x2, 0x1, 0x30, 0xF, 0x6, 0xA, 0x2B, 0x6, 0x1, 0x4, 0x1, 0x82, 0xC4, 0xA, 0x3, 0x9, 0x4, 0x1, 0x1, 0x30, 0xD, 0x6, 0x9, 0x2A, 0x86, 0x48, 0x86, 0xF7, 0xD, 0x1, 0x1, 0xB, 0x5, 0x0, 0x3, 0x82, 0x1, 0x1, 0x0, 0x1, 0x50, 0xF7, 0xAC, 0x9E, 0x6F, 0x6A, 0x3, 0x3B, 0xC0, 0x88, 0xA7, 0xB4, 0xC9, 0x3E, 0xB5, 0xB2, 0xAB, 0x57, 0x1B, 0x16, 0x6, 0x3A, 0x54, 0x99, 0x74, 0xC3, 0xC2, 0x18, 0xE2, 0x3A, 0x25, 0xB, 0x5D, 0x8E, 0x52, 0x7B, 0xD9, 0xA4, 0x7A, 0x4D, 0x98, 0x42, 0x85, 0x8C, 0x75, 0x77, 0xEC, 0xD4, 0x3A, 0x2E, 0xB3, 0x32, 0xFA, 0xE4, 0x42, 0x4E, 0x4E, 0xCD, 0xDD, 0x5A, 0x99, 0xCA, 0xF3, 0x8E, 0xBB, 0xA7, 0x84, 0xB9, 0xF1, 0x72, 0x5B, 0xAE, 0x97, 0x25, 0xF0, 0x9F, 0x5, 0x38, 0xE3, 0x5B, 0xAC, 0xE, 0xE7, 0x1, 0x7E, 0x76, 0xC7, 0x41, 0xF, 0x8E, 0xEB, 0x65, 0xE9, 0xEF, 0x86, 0x96, 0xD5, 0x61, 0x97, 0xE4, 0xDA, 0xE8, 0x90, 0xC1, 0x86, 0x89, 0x33, 0x5E, 0xA2, 0xDA, 0xA3, 0xD, 0x88, 0xFD, 0xCA, 0xD, 0x7A, 0xD6, 0x2D, 0x3D, 0xA0, 0x76, 0xAA, 0xC3, 0xCC, 0xEE, 0x7, 0xE2, 0xFE, 0x78, 0x94, 0xF2, 0xCE, 0x72, 0x6F, 0xF2, 0x39, 0x13, 0x53, 0xBC, 0xE9, 0x56, 0xEC, 0x29, 0x8, 0x1D, 0x23, 0x6F, 0xAB, 0x6C, 0x41, 0xF2, 0x53, 0x82, 0xCF, 0x35, 0xA2, 0xFD, 0x52, 0xFF, 0xED, 0xBC, 0x5F, 0x8B, 0xE1, 0x7E, 0x99, 0xDC, 0xB1, 0x84, 0x6C, 0x77, 0x49, 0xE, 0x10, 0xF4, 0x9F, 0x25, 0x86, 0x79, 0x4B, 0xC4, 0xD7, 0xF0, 0xFA, 0x39, 0x68, 0xB8, 0xD3, 0x1D, 0x84, 0x64, 0xFB, 0x56, 0x57, 0x1E, 0xD8, 0x2E, 0x51, 0xD1, 0x99, 0x72, 0xC2, 0x2D, 0x10, 0x4A, 0x18, 0xE0, 0xB, 0x9, 0x73, 0xCD, 0xF0, 0xD8, 0x3A, 0x65, 0xCA, 0x92, 0x8, 0x94, 0x93, 0xEB, 0x2B, 0xD4, 0x17, 0xAF, 0xB9, 0xC6, 0x62, 0x22, 0xCB, 0xEB, 0x28, 0xEE, 0xB1, 0x98, 0x66, 0x22, 0x86, 0x8, 0x16, 0x93, 0x8, 0x12, 0xA4, 0x12, 0x1E, 0xA0, 0x3E, 0x1B, 0x7C, 0x76, 0x60, 0x4F, 0x13, 0x30, 0x82, 0x3, 0xE, 0x6, 0xA, 0x2B, 0x6, 0x1, 0x4, 0x1, 0x82, 0xC4, 0xA, 0x3, 0x2, 0x4, 0x82, 0x2, 0xFE, 0x30, 0x82, 0x2, 0xFA, 0x30, 0x82, 0x1, 0xE2, 0xA0, 0x3, 0x2, 0x1, 0x2, 0x2, 0x9, 0x0, 0xE8, 0xC3, 0xDD, 0x79, 0x9E, 0x43, 0x3B, 0x62, 0x30, 0xD, 0x6, 0x9, 0x2A, 0x86, 0x48, 0x86, 0xF7, 0xD, 0x1, 0x1, 0xB, 0x5, 0x0, 0x30, 0x2B, 0x31, 0x29, 0x30, 0x27, 0x6, 0x3, 0x55, 0x4, 0x3, 0xC, 0x20, 0x59, 0x75, 0x62, 0x69, 0x63, 0x6F, 0x20, 0x50, 0x49, 0x56, 0x20, 0x52, 0x6F, 0x6F, 0x74, 0x20, 0x43, 0x41, 0x20, 0x53, 0x65, 0x72, 0x69, 0x61, 0x6C, 0x20, 0x32, 0x36, 0x33, 0x37, 0x35, 0x31, 0x30, 0x20, 0x17, 0xD, 0x31, 0x36, 0x30, 0x33, 0x31, 0x34, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x5A, 0x18, 0xF, 0x32, 0x30, 0x35, 0x32, 0x30, 0x34, 0x31, 0x37, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x5A, 0x30, 0x21, 0x31, 0x1F, 0x30, 0x1D, 0x6, 0x3, 0x55, 0x4, 0x3, 0xC, 0x16, 0x59, 0x75, 0x62, 0x69, 0x63, 0x6F, 0x20, 0x50, 0x49, 0x56, 0x20, 0x41, 0x74, 0x74, 0x65, 0x73, 0x74, 0x61, 0x74, 0x69, 0x6F, 0x6E, 0x30, 0x82, 0x1, 0x22, 0x30, 0xD, 0x6, 0x9, 0x2A, 0x86, 0x48, 0x86, 0xF7, 0xD, 0x1, 0x1, 0x1, 0x5, 0x0, 0x3, 0x82, 0x1, 0xF, 0x0, 0x30, 0x82, 0x1, 0xA, 0x2, 0x82, 0x1, 0x1, 0x0, 0xBD, 0x3D, 0x3E, 0x27, 0xF4, 0x11, 0xEA, 0xCA, 0x9C, 0x15, 0x52, 0x8D, 0xAA, 0xBC, 0xEC, 0x90, 0x50, 0x6F, 0x7A, 0x9D, 0x96, 0x69, 0x2, 0xB2, 0x5F, 0x81, 0xCF, 0xED, 0x2, 0xCF, 0x3F, 0x62, 0x59, 0x36, 0x6E, 0xB3, 0x10, 0x8C, 0x72, 0x22, 0xD0, 0x1F, 0x1F, 0x68, 0x84, 0x5B, 0x8E, 0xB4, 0xAC, 0x39, 0x2E, 0xAF, 0x56, 0x4E, 0x99, 0x5F, 0xE3, 0xFF, 0x71, 0x7D, 0x6D, 0x47, 0x56, 0xB6, 0x84, 0xA6, 0x7E, 0x85, 0xB6, 0x94, 0xB8, 0x2E, 0xB0, 0x11, 0x33, 0xD0, 0x58, 0xE, 0x4B, 0xCD, 0x69, 0xBF, 0x3E, 0xA1, 0x71, 0xFD, 0xBE, 0x99, 0x6F, 0xA, 0x7A, 0x7, 0x6F, 0x66, 0xA0, 0xDB, 0x44, 0x8D, 0x8E, 0x39, 0x77, 0x77, 0xB6, 0xD7, 0xB4, 0xF, 0x8F, 0x9, 0x6B, 0xC0, 0xF8, 0xC7, 0x4E, 0x69, 0x8F, 0x67, 0xCC, 0x59, 0x87, 0xBC, 0x7F, 0x96, 0x2A, 0xDC, 0x18, 0xEF, 0x9E, 0xCE, 0x40, 0xB6, 0x55, 0x72, 0x43, 0x95, 0x1, 0x25, 0xB, 0x34, 0xCC, 0x55, 0x81, 0x35, 0xD0, 0xCF, 0x3D, 0x36, 0x27, 0x26, 0xDC, 0x36, 0x43, 0x86, 0x67, 0xF2, 0x96, 0x4C, 0x1C, 0x84, 0x57, 0xE0, 0x54, 0xCB, 0xA5, 0x7F, 0x35, 0x18, 0xD, 0xA1, 0xA7, 0x91, 0xE9, 0x68, 0x22, 0xD8, 0x65, 0x5E, 0x93, 0xF8, 0x5D, 0x53, 0x60, 0xCB, 0xAE, 0x4D, 0xC6, 0x7, 0x62, 0xCB, 0x8F, 0x1C, 0xAF, 0xCA, 0x13, 0x2E, 0xBD, 0x55, 0x2E, 0x14, 0xB7, 0x6E, 0x68, 0xD3, 0x67, 0x4E, 0xA5, 0x8F, 0x5D, 0xD2, 0x60, 0x23, 0x85, 0xED, 0xFB, 0xC0, 0x90, 0xBC, 0x9E, 0x99, 0xFC, 0x2E, 0x3F, 0x8F, 0x36, 0xD0, 0x6F, 0x8E, 0xFD, 0xAD, 0xEC, 0xD4, 0xF5, 0xD9, 0xA4, 0xBC, 0x5C, 0x6E, 0xC9, 0xF, 0xD5, 0x8B, 0x1A, 0x3A, 0xBE, 0xBE, 0x16, 0xF, 0x8, 0x4A, 0xDD, 0x1D, 0xE4, 0xC4, 0xDC, 0x27, 0xAE, 0xF7, 0x2, 0x3, 0x1, 0x0, 0x1, 0xA3, 0x29, 0x30, 0x27, 0x30, 0x11, 0x6, 0xA, 0x2B, 0x6, 0x1, 0x4, 0x1, 0x82, 0xC4, 0xA, 0x3, 0x3, 0x4, 0x3, 0x5, 0x4, 0x3, 0x30, 0x12, 0x6, 0x3, 0x55, 0x1D, 0x13, 0x1, 0x1, 0xFF, 0x4, 0x8, 0x30, 0x6, 0x1, 0x1, 0xFF, 0x2, 0x1, 0x0, 0x30, 0xD, 0x6, 0x9, 0x2A, 0x86, 0x48, 0x86, 0xF7, 0xD, 0x1, 0x1, 0xB, 0x5, 0x0, 0x3, 0x82, 0x1, 0x1, 0x0, 0x5B, 0x86, 0x79, 0x3D, 0x1D, 0x9A, 0x8D, 0xB5, 0x27, 0xAA, 0x81, 0xF5, 0x5F, 0xC3, 0x26, 0x1C, 0x26, 0x67, 0x5D, 0xFB, 0x0, 0xF4, 0xCD, 0x4, 0xAB, 0x34, 0x11, 0xF8, 0x57, 0xD2, 0x4A, 0xB7, 0x7F, 0xD8, 0xDF, 0xBB, 0xE5, 0x18, 0xB3, 0x6F, 0x61, 0x6B, 0x6, 0x87, 0x3F, 0xBE, 0xF7, 0x2A, 0xDB, 0x16, 0x39, 0x48, 0xD, 0xA1, 0x42, 0xBA, 0xB6, 0x9B, 0xEC, 0x36, 0x3B, 0xBE, 0x3, 0xF5, 0x1B, 0x1, 0xF5, 0x27, 0x2D, 0x45, 0x7D, 0xCE, 0xB8, 0x6C, 0x55, 0x2A, 0x4, 0x14, 0xD1, 0x2D, 0x32, 0x1A, 0xA3, 0x17, 0x5E, 0x95, 0x52, 0x35, 0x3E, 0x76, 0x47, 0x20, 0x8B, 0xF3, 0xCE, 0x3A, 0x8E, 0x6E, 0x34, 0x3B, 0x79, 0xEE, 0x7B, 0x83, 0xF6, 0x26, 0xD6, 0x19, 0xE9, 0x34, 0x7B, 0x8D, 0x65, 0x18, 0xA6, 0xE5, 0x45, 0x25, 0x99, 0xEA, 0x86, 0xB5, 0xD5, 0xB0, 0xB4, 0x3E, 0xE, 0x24, 0xC4, 0xE3, 0xA6, 0xC, 0xC7, 0xAD, 0x66, 0xF5, 0xA, 0xA1, 0x9E, 0xD0, 0x84, 0xDD, 0x98, 0xD3, 0x5D, 0xBD, 0xBF, 0x76, 0xC2, 0x2B, 0x7C, 0xDE, 0xFF, 0x7, 0xA1, 0xDF, 0xF1, 0xF7, 0x84, 0x74, 0xD1, 0x68, 0xE6, 0x7E, 0x1C, 0xA, 0x3E, 0x2C, 0x17, 0x9B, 0xF3, 0x7E, 0x50, 0x6C, 0x6B, 0xCA, 0x5E, 0xBC, 0x71, 0xE5, 0x2C, 0xC3, 0x6C, 0xBD, 0x59, 0x4C, 0x22, 0xC7, 0x14, 0x8C, 0x47, 0xCB, 0x90, 0x73, 0x29, 0xBA, 0x6B, 0x5D, 0xEA, 0x9A, 0xDB, 0x70, 0xCC, 0x69, 0xCB, 0x26, 0xB1, 0x35, 0x75, 0xBE, 0x65, 0x63, 0xB1, 0x8F, 0xE5, 0xE3, 0x69, 0x93, 0x25, 0xAC, 0x9A, 0xBD, 0x1, 0x2B, 0x1B, 0xDD, 0x7, 0xEE, 0x4, 0xC8, 0x98, 0x20, 0xD8, 0xC1, 0xC5, 0x4F, 0x1, 0xAD, 0xA7, 0x50, 0x58, 0xB8, 0xD9, 0xCB, 0xEC, 0x6D, 0xAC, 0x14, 0x9D, 0x3, 0x35, 0x22, 0x23, 0xF6, 0x98, 0x3F, 0x30, 0xA, 0x6, 0x8, 0x2A, 0x86, 0x48, 0xCE, 0x3D, 0x4, 0x3, 0x3, 0x3, 0x68, 0x0, 0x30, 0x65, 0x2, 0x30, 0x76, 0x88, 0x93, 0xC4, 0x75, 0x59, 0xF9, 0xA2, 0x23, 0xB, 0xB, 0x3E, 0x1C, 0x2C, 0xCC, 0x8A, 0xF3, 0xAA, 0x84, 0x74, 0x6D, 0x80, 0xEE, 0x8A, 0xBF, 0xBF, 0xAD, 0x89, 0xEF, 0x92, 0x4C, 0xFB, 0xB, 0xCA, 0xF2, 0xBF, 0xB2, 0x5E, 0x2D, 0x80, 0xF8, 0x37, 0x8A, 0x6D, 0x8B, 0x64, 0x1A, 0xDD, 0x2, 0x31, 0x0, 0xA8, 0x4E, 0xFF, 0x75, 0x3F, 0xD4, 0xDF, 0x10, 0xC7, 0x75, 0xB, 0x8D, 0x68, 0x13, 0x1D, 0xFE, 0x24, 0x12, 0x1C, 0x9C, 0xD6, 0x7F, 0xFA, 0x11, 0xC6, 0x1F, 0x4, 0x78, 0xBE, 0x9E, 0x48, 0x95, 0xBC, 0x16, 0xD5, 0x8B, 0x73, 0x46, 0x50, 0x33, 0x89, 0xA0, 0x6F, 0x20, 0x3, 0x66, 0x91, 0x7B)
        $pest_return = Confirm-YubikeyAttestion -CertificateRequest $pest_input      
        $pest_return | Should -BeOfType VirotYubikey.Attestion
        $pest_return.Slot | Should -Be 0x9a
        $pest_return.AttestionValidated | Should -Be $True
        $pest_return.AttestionMatchesCSR | Should -Be $True
    }

}

Describe "Confirm-YubikeyAttestion JustAttestCertificate" {
    BeforeEach -Scriptblock {
        #Get-Variable pest*|Remove-Variable
    }

    It -Name "Verify '-AttestionCertificate _PEM_ -IntermediateCertificate _PEM_' works" -Test {
        $pest_att = @'
-----BEGIN CERTIFICATE-----
MIICcjCCAVqgAwIBAgIQAb2BSDpzHqVMClTGWqV8TDANBgkqhkiG9w0BAQsFADAh
MR8wHQYDVQQDDBZZdWJpY28gUElWIEF0dGVzdGF0aW9uMCAXDTE2MDMxNDAwMDAw
MFoYDzIwNTIwNDE3MDAwMDAwWjAlMSMwIQYDVQQDDBpZdWJpS2V5IFBJViBBdHRl
c3RhdGlvbiA5YTB2MBAGByqGSM49AgEGBSuBBAAiA2IABBhJxQO9S01CiALFX/ts
1GqCCK7etz5O8z0DHRzmPjlBQpdOZ0o8HycAfbpIWGdASqeTPLQuLuAE0fV3yz7T
agwczViL16W+cFO/oLVP2c4u+KwRuZwlMxcLToqCHM8fUqNOMEwwEQYKKwYBBAGC
xAoDAwQDBQQDMBQGCisGAQQBgsQKAwcEBgIEASwDdzAQBgorBgEEAYLECgMIBAIC
ATAPBgorBgEEAYLECgMJBAEBMA0GCSqGSIb3DQEBCwUAA4IBAQBkQpDPfl/pN8ya
Aqc6bubqZCzBa+3V7xlqkW2W6g05Lda+FxX8BILo7OgW5MSSgEuj50V8KShq1rqo
EaMtFVNvTPecxKhoXQElVZRKHv4WaKmpOTYU9Bbe7MHOj0VKQn8iD63K2vyAIxjP
we4g8d7oCKWHABUimVu9fgBzeFGRm34GMSHW8sUHxOI4Qoh2zSauthBJ0yuCMfJc
cGmeEcl3IlfaKr8e57z0VVOijFaLTOg8X7JYQ6gzuM/oi9fBwGRWimhgnGppk9RN
uhufs5JEmAxKSrUuaapj7vYWsVnw4HXYyBklKyZI3KQI9H3L5mCgLdzfKSaWLqIu
KI1mzSl/
-----END CERTIFICATE-----
'@
$pest_int = @'
-----BEGIN CERTIFICATE-----
MIIC+jCCAeKgAwIBAgIJAOjD3XmeQztiMA0GCSqGSIb3DQEBCwUAMCsxKTAnBgNV
BAMMIFl1YmljbyBQSVYgUm9vdCBDQSBTZXJpYWwgMjYzNzUxMCAXDTE2MDMxNDAw
MDAwMFoYDzIwNTIwNDE3MDAwMDAwWjAhMR8wHQYDVQQDDBZZdWJpY28gUElWIEF0
dGVzdGF0aW9uMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAvT0+J/QR
6sqcFVKNqrzskFBvep2WaQKyX4HP7QLPP2JZNm6zEIxyItAfH2iEW460rDkur1ZO
mV/j/3F9bUdWtoSmfoW2lLgusBEz0FgOS81pvz6hcf2+mW8KegdvZqDbRI2OOXd3
tte0D48Ja8D4x05pj2fMWYe8f5Yq3Bjvns5AtlVyQ5UBJQs0zFWBNdDPPTYnJtw2
Q4Zn8pZMHIRX4FTLpX81GA2hp5HpaCLYZV6T+F1TYMuuTcYHYsuPHK/KEy69VS4U
t25o02dOpY9d0mAjhe37wJC8npn8Lj+PNtBvjv2t7NT12aS8XG7JD9WLGjq+vhYP
CErdHeTE3Ceu9wIDAQABoykwJzARBgorBgEEAYLECgMDBAMFBAMwEgYDVR0TAQH/
BAgwBgEB/wIBADANBgkqhkiG9w0BAQsFAAOCAQEAW4Z5PR2ajbUnqoH1X8MmHCZn
XfsA9M0EqzQR+FfSSrd/2N+75Rizb2FrBoc/vvcq2xY5SA2hQrq2m+w2O74D9RsB
9SctRX3OuGxVKgQU0S0yGqMXXpVSNT52RyCL8846jm40O3nue4P2JtYZ6TR7jWUY
puVFJZnqhrXVsLQ+DiTE46YMx61m9QqhntCE3ZjTXb2/dsIrfN7/B6Hf8feEdNFo
5n4cCj4sF5vzflBsa8pevHHlLMNsvVlMIscUjEfLkHMpumtd6prbcMxpyyaxNXW+
ZWOxj+XjaZMlrJq9ASsb3QfuBMiYINjBxU8BradQWLjZy+xtrBSdAzUiI/aYPw==
-----END CERTIFICATE-----
'@
        $pest_return = Confirm-YubikeyAttestion -AttestionCertificate $pest_att -IntermediateCertificate $pest_int
        $pest_return | Should -BeOfType VirotYubikey.Attestion
        $pest_return.Slot | Should -Be 0x9a
        $pest_return.AttestionValidated | Should -BeTrue
        $pest_return.AttestionMatchesCSR | Should -BeNullOrEmpty
    }
    It -Name "Verify '-AttestionCertificate _X509Certificate2_ -IntermediateCertificate _X509Certificate2_' works" -Test {
        $pest_att = [System.Security.Cryptography.X509Certificates.X509Certificate2]::new([byte[]](48,130,2,114,48,130,1,90,160,3,2,1,2,2,16,1,189,129,72,58,115,30,165,76,10,84,198,90,165,124,76,48,13,6,9,42,134,72,134,247,13,1,1,11,5,0,48,33,49,31,48,29,6,3,85,4,3,12,22,89,117,98,105,99,111,32,80,73,86,32,65,116,116,101,115,116,97,116,105,111,110,48,32,23,13,49,54,48,51,49,52,48,48,48,48,48,48,90,24,15,50,48,53,50,48,52,49,55,48,48,48,48,48,48,90,48,37,49,35,48,33,6,3,85,4,3,12,26,89,117,98,105,75,101,121,32,80,73,86,32,65,116,116,101,115,116,97,116,105,111,110,32,57,97,48,118,48,16,6,7,42,134,72,206,61,2,1,6,5,43,129,4,0,34,3,98,0,4,24,73,197,3,189,75,77,66,136,2,197,95,251,108,212,106,130,8,174,222,183,62,78,243,61,3,29,28,230,62,57,65,66,151,78,103,74,60,31,39,0,125,186,72,88,103,64,74,167,147,60,180,46,46,224,4,209,245,119,203,62,211,106,12,28,205,88,139,215,165,190,112,83,191,160,181,79,217,206,46,248,172,17,185,156,37,51,23,11,78,138,130,28,207,31,82,163,78,48,76,48,17,6,10,43,6,1,4,1,130,196,10,3,3,4,3,5,4,3,48,20,6,10,43,6,1,4,1,130,196,10,3,7,4,6,2,4,1,44,3,119,48,16,6,10,43,6,1,4,1,130,196,10,3,8,4,2,2,1,48,15,6,10,43,6,1,4,1,130,196,10,3,9,4,1,1,48,13,6,9,42,134,72,134,247,13,1,1,11,5,0,3,130,1,1,0,100,66,144,207,126,95,233,55,204,154,2,167,58,110,230,234,100,44,193,107,237,213,239,25,106,145,109,150,234,13,57,45,214,190,23,21,252,4,130,232,236,232,22,228,196,146,128,75,163,231,69,124,41,40,106,214,186,168,17,163,45,21,83,111,76,247,156,196,168,104,93,1,37,85,148,74,30,254,22,104,169,169,57,54,20,244,22,222,236,193,206,143,69,74,66,127,34,15,173,202,218,252,128,35,24,207,193,238,32,241,222,232,8,165,135,0,21,34,153,91,189,126,0,115,120,81,145,155,126,6,49,33,214,242,197,7,196,226,56,66,136,118,205,38,174,182,16,73,211,43,130,49,242,92,112,105,158,17,201,119,34,87,218,42,191,30,231,188,244,85,83,162,140,86,139,76,232,60,95,178,88,67,168,51,184,207,232,139,215,193,192,100,86,138,104,96,156,106,105,147,212,77,186,27,159,179,146,68,152,12,74,74,181,46,105,170,99,238,246,22,177,89,240,224,117,216,200,25,37,43,38,72,220,164,8,244,125,203,230,96,160,45,220,223,41,38,150,46,162,46,40,141,102,205,41,127))

$pest_int = [System.Security.Cryptography.X509Certificates.X509Certificate2]::new([byte[]](48,130,2,250,48,130,1,226,160,3,2,1,2,2,9,0,232,195,221,121,158,67,59,98,48,13,6,9,42,134,72,134,247,13,1,1,11,5,0,48,43,49,41,48,39,6,3,85,4,3,12,32,89,117,98,105,99,111,32,80,73,86,32,82,111,111,116,32,67,65,32,83,101,114,105,97,108,32,50,54,51,55,53,49,48,32,23,13,49,54,48,51,49,52,48,48,48,48,48,48,90,24,15,50,48,53,50,48,52,49,55,48,48,48,48,48,48,90,48,33,49,31,48,29,6,3,85,4,3,12,22,89,117,98,105,99,111,32,80,73,86,32,65,116,116,101,115,116,97,116,105,111,110,48,130,1,34,48,13,6,9,42,134,72,134,247,13,1,1,1,5,0,3,130,1,15,0,48,130,1,10,2,130,1,1,0,189,61,62,39,244,17,234,202,156,21,82,141,170,188,236,144,80,111,122,157,150,105,2,178,95,129,207,237,2,207,63,98,89,54,110,179,16,140,114,34,208,31,31,104,132,91,142,180,172,57,46,175,86,78,153,95,227,255,113,125,109,71,86,182,132,166,126,133,182,148,184,46,176,17,51,208,88,14,75,205,105,191,62,161,113,253,190,153,111,10,122,7,111,102,160,219,68,141,142,57,119,119,182,215,180,15,143,9,107,192,248,199,78,105,143,103,204,89,135,188,127,150,42,220,24,239,158,206,64,182,85,114,67,149,1,37,11,52,204,85,129,53,208,207,61,54,39,38,220,54,67,134,103,242,150,76,28,132,87,224,84,203,165,127,53,24,13,161,167,145,233,104,34,216,101,94,147,248,93,83,96,203,174,77,198,7,98,203,143,28,175,202,19,46,189,85,46,20,183,110,104,211,103,78,165,143,93,210,96,35,133,237,251,192,144,188,158,153,252,46,63,143,54,208,111,142,253,173,236,212,245,217,164,188,92,110,201,15,213,139,26,58,190,190,22,15,8,74,221,29,228,196,220,39,174,247,2,3,1,0,1,163,41,48,39,48,17,6,10,43,6,1,4,1,130,196,10,3,3,4,3,5,4,3,48,18,6,3,85,29,19,1,1,255,4,8,48,6,1,1,255,2,1,0,48,13,6,9,42,134,72,134,247,13,1,1,11,5,0,3,130,1,1,0,91,134,121,61,29,154,141,181,39,170,129,245,95,195,38,28,38,103,93,251,0,244,205,4,171,52,17,248,87,210,74,183,127,216,223,187,229,24,179,111,97,107,6,135,63,190,247,42,219,22,57,72,13,161,66,186,182,155,236,54,59,190,3,245,27,1,245,39,45,69,125,206,184,108,85,42,4,20,209,45,50,26,163,23,94,149,82,53,62,118,71,32,139,243,206,58,142,110,52,59,121,238,123,131,246,38,214,25,233,52,123,141,101,24,166,229,69,37,153,234,134,181,213,176,180,62,14,36,196,227,166,12,199,173,102,245,10,161,158,208,132,221,152,211,93,189,191,118,194,43,124,222,255,7,161,223,241,247,132,116,209,104,230,126,28,10,62,44,23,155,243,126,80,108,107,202,94,188,113,229,44,195,108,189,89,76,34,199,20,140,71,203,144,115,41,186,107,93,234,154,219,112,204,105,203,38,177,53,117,190,101,99,177,143,229,227,105,147,37,172,154,189,1,43,27,221,7,238,4,200,152,32,216,193,197,79,1,173,167,80,88,184,217,203,236,109,172,20,157,3,53,34,35,246,152,63))

        $pest_return = Confirm-YubikeyAttestion -AttestionCertificate $pest_att -IntermediateCertificate $pest_int
        $pest_return | Should -BeOfType VirotYubikey.Attestion
        $pest_return.Slot | Should -Be 0x9a
        $pest_return.AttestionValidated | Should -BeTrue
        $pest_return.AttestionMatchesCSR | Should -BeNullOrEmpty
    }
}

AfterAll -Scriptblock {
    $csr,$attestationcert,$intermediatecert |ForEach {if (Test-Path $_){ Remove-Item $_ }}
}